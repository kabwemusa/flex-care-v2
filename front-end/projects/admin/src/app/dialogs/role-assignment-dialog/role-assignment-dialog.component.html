<div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-white">
  <div class="flex items-center gap-3">
    <div class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-50 border border-blue-100 text-blue-600 font-bold text-sm">
      {{ getUserInitials() }}
    </div>
    <div>
      <h2 class="text-lg font-semibold text-gray-900">Assign Roles</h2>
      <p class="text-sm text-gray-500">{{ user.email }}</p>
    </div>
  </div>
  <button mat-icon-button (click)="onCancel()" class="!text-gray-400 hover:!text-gray-600 hover:!bg-gray-100 transition-colors">
    <mat-icon fontSet="material-symbols-rounded">close</mat-icon>
  </button>
</div>

<mat-dialog-content class="!p-0 !max-h-[75vh] !overflow-hidden">
  <div class="flex flex-col md:flex-row h-[500px] w-[800px] max-w-[90vw]">
    
    <div class="w-full md:w-72 border-b md:border-b-0 md:border-r border-gray-200 bg-gray-50 flex-shrink-0 flex flex-col p-5">
      
      <form [formGroup]="roleForm" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">Module Context</label>
          <mat-form-field appearance="outline" class="w-full custom-input" subscriptSizing="dynamic">
            <mat-select formControlName="guard" (selectionChange)="onGuardChange()" class="!text-sm">
              
              <mat-select-trigger>
                <div class="flex items-center gap-2">
                  <mat-icon fontSet="material-symbols-rounded" class="!text-gray-500 !text-lg !w-5 !h-5 !leading-5 align-middle">
                    {{ getSelectedScopeIcon() }}
                  </mat-icon>
                  <span>{{ getSelectedScopeLabel() }}</span>
                </div>
              </mat-select-trigger>

              @for (scope of moduleScopes; track scope.value) {
                <mat-option [value]="scope.value">
                  <div class="flex items-center gap-2">
                    <mat-icon fontSet="material-symbols-rounded" class="!text-gray-500 !text-lg !w-5 !h-5 !leading-5 align-middle">
                      {{ scope.icon }}
                    </mat-icon>
                    <span>{{ scope.label }}</span>
                  </div>
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
          <p class="text-xs text-gray-500 mt-2">
            Select the system module to filter available roles.
          </p>
        </div>
      </form>

      <div class="mt-auto">
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Summary</p>
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600">Roles Assigned</span>
            <span class="inline-flex items-center justify-center bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-0.5 rounded-full">
              {{ selectedRoles().length }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="flex-1 flex flex-col min-w-0 bg-white">
      
      <div class="px-5 py-3 border-b border-gray-200 flex items-center justify-between bg-white sticky top-0 z-10">
        <h3 class="text-sm font-semibold text-gray-900">Available Roles</h3>
        
        <div class="relative w-48">
          <mat-icon class="absolute left-2 top-1/2 -translate-y-1/2 !text-gray-400 !text-base">search</mat-icon>
          <input 
            type="text" 
            placeholder="Search roles..." 
            class="w-full pl-8 pr-3 py-1 text-sm border border-gray-200 rounded-md focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
            (input)="filterRoles($any($event.target).value)"
          >
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-5">
        @if (store.isLoading()) {
          <div class="flex justify-center py-12"><mat-spinner diameter="30"></mat-spinner></div>
        } @else if (filteredRoles().length === 0) {
          <div class="flex flex-col items-center justify-center py-12 text-center opacity-60">
            <mat-icon class="!text-4xl text-gray-300 mb-2">person_off</mat-icon>
            <p class="text-sm text-gray-500">No roles found for this module.</p>
          </div>
        } @else {
          <div class="grid grid-cols-1 gap-3">
            @for (role of filteredRoles(); track role.id) {
              <label 
                class="flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all group select-none"
                [class.border-indigo-200]="isRoleSelected(role.name)"
                [class.bg-indigo-50/30]="isRoleSelected(role.name)"
                [class.border-gray-200]="!isRoleSelected(role.name)"
                [class.hover:border-indigo-200]="!isRoleSelected(role.name)"
                [class.hover:bg-gray-50]="!isRoleSelected(role.name)"
              >
                <input 
                  type="checkbox" 
                  class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"
                  [checked]="isRoleSelected(role.name)"
                  (change)="toggleRole(role.name, $any($event.target).checked)"
                >

                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-gray-900">{{ role.name }}</span>
                    <span 
                      class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-gray-100 text-gray-500 group-hover:bg-white group-hover:text-indigo-600 transition-colors"
                      [title]="getPermissionsList(role)"
                      aria-label="{{ getPermissionsList(role) }}"
                    >
                      {{ role.permissions?.length || 0 }} perms
                    </span>
                  </div>
                  <p class="text-xs text-gray-500 mt-0.5 truncate">
                    ID: #{{ role.id }} &bull; Guard: {{ role.guard_name }}
                  </p>
                </div>

                @if (isRoleSelected(role.name)) {
                  <mat-icon class="!text-indigo-600 !text-lg">check_circle</mat-icon>
                }
              </label>
            }
          </div>
        }
      </div>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions class="!px-6 !py-4 !border-t !border-gray-200 !flex !justify-end !bg-gray-50">
  <button mat-button (click)="onCancel()" class="!text-gray-600 !mr-2">Cancel</button>
  <button mat-flat-button color="primary" (click)="onSave()" class="!rounded-lg !px-6"
    [disabled]="store.isSaving()">
    @if (store.isSaving()) {
      <mat-spinner diameter="18" class="!mr-2 !text-white"></mat-spinner> Saving...
    } @else {
      Assign Roles
    }
  </button>
</mat-dialog-actions>