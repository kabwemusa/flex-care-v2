<div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-white">
  <div class="flex items-center gap-3">
    <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-indigo-50">
      <mat-icon fontSet="material-symbols-rounded" class="!text-indigo-600 !text-xl"
        >shield_person</mat-icon
      >
    </div>
    <div>
      <h2 class="text-lg font-semibold text-gray-900">
        {{ isEdit ? 'Edit Role' : 'Create Role' }}
      </h2>
      <p class="text-sm text-gray-500">Configure role permissions</p>
    </div>
  </div>
  <button
    mat-icon-button
    (click)="onCancel()"
    class="!text-gray-400 hover:!text-gray-600 hover:!bg-gray-100 transition-colors"
  >
    <mat-icon fontSet="material-symbols-rounded">close</mat-icon>
  </button>
</div>

<mat-dialog-content class="!p-0 !max-h-[75vh] !overflow-hidden">
  <div class="flex flex-col md:flex-row h-[560px] w-[900px] max-w-[90vw]">
    <div
      class="w-full md:w-72 border-b md:border-b-0 md:border-r border-gray-200 bg-gray-50 flex-shrink-0 flex flex-col"
    >
      <div class="p-5 flex-1">
        <form [formGroup]="roleForm" class="space-y-5">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5"
              >Role Name <span class="text-red-500">*</span></label
            >
            <mat-form-field
              appearance="outline"
              class="w-full custom-input"
              subscriptSizing="dynamic"
            >
              <input
                matInput
                formControlName="name"
                placeholder="Enter role name"
                class="!text-sm text-gray-900"
              />
              @if (roleForm.get('name')?.hasError('required') && roleForm.get('name')?.touched) {
              <mat-error class="text-xs">Required</mat-error>
              }
            </mat-form-field>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5"
              >Module Scope <span class="text-red-500">*</span></label
            >
            <mat-form-field
              appearance="outline"
              class="w-full custom-input"
              subscriptSizing="dynamic"
            >
              <mat-select
                formControlName="guard_name"
                (selectionChange)="onGuardChange()"
                class="!text-sm"
              >
                <mat-select-trigger>
                  <div class="flex items-center gap-2">
                    <mat-icon
                      fontSet="material-symbols-rounded"
                      class="!text-gray-500 !text-lg !w-5 !h-5 !leading-5 align-middle"
                    >
                      {{ getSelectedScopeIcon() }}
                    </mat-icon>
                    <span>{{ getSelectedScopeLabel() }}</span>
                  </div>
                </mat-select-trigger>

                @for (scope of moduleScopes; track scope.value) {
                <mat-option [value]="scope.value">
                  <div class="flex items-center gap-2">
                    <mat-icon
                      fontSet="material-symbols-rounded"
                      class="!text-gray-500 !text-lg !w-5 !h-5 !leading-5 align-middle"
                    >
                      {{ scope.icon }}
                    </mat-icon>
                    <span>{{ scope.label }}</span>
                  </div>
                </mat-option>
                }
              </mat-select>
            </mat-form-field>
            <p class="text-xs text-gray-500 mt-2 leading-tight">
              Determines which application module this role applies to.
            </p>
          </div>
        </form>
      </div>

      <div class="p-5 border-t border-gray-200">
        <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
          <div class="flex justify-between items-center mb-1">
            <span class="text-xs font-semibold text-gray-500 uppercase">Selected</span>
            <span class="text-sm font-bold text-indigo-600">{{
              selectedPermissions().length
            }}</span>
          </div>
          <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2">
            <div
              class="bg-indigo-600 h-1.5 rounded-full transition-all duration-300"
              [style.width.%]="(selectedPermissions().length / totalPermissionCount()) * 100"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex-1 flex flex-col min-w-0 bg-white">
      <div
        class="px-5 py-3 border-b border-gray-200 flex items-center gap-3 bg-white sticky top-0 z-10"
      >
        <div class="relative flex-1">
          <mat-icon
            fontSet="material-symbols-rounded"
            class="absolute left-3 top-1/2 -translate-y-1/2 !text-gray-400 !text-lg"
            >search</mat-icon
          >
          <input
            type="text"
            [(ngModel)]="searchQuery"
            placeholder="Filter permissions..."
            class="w-full pl-9 pr-4 py-1.5 text-sm bg-gray-50 border border-gray-200 rounded-md focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-shadow"
          />
        </div>
        <div class="flex items-center gap-2">
          <button mat-button (click)="selectAllPermissions()" class="!text-xs !h-8 text-gray-600">
            Select All
          </button>
          <button mat-button (click)="clearAllPermissions()" class="!text-xs !h-8 !text-red-500">
            Clear
          </button>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-6 bg-white">
        @if (store.isLoading()) {
        <div class="flex justify-center py-10"><mat-spinner diameter="30"></mat-spinner></div>
        } @else {
        <div class="space-y-8">
          @for (category of filteredCategories(); track category) {
          <div>
            <div
              class="flex items-center justify-between mb-3 pb-2 border-b border-gray-100 group/header"
            >
              <h3 class="text-sm font-bold text-gray-900 capitalize flex items-center gap-2">
                {{ formatCategoryName(category) }}
              </h3>
              <div class="flex gap-3 opacity-0 group-hover/header:opacity-100 transition-opacity">
                <button
                  (click)="selectCategoryPermissions(category)"
                  class="text-[11px] font-medium text-indigo-600 hover:text-indigo-800"
                >
                  All
                </button>
                <button
                  (click)="clearCategoryPermissions(category)"
                  class="text-[11px] font-medium text-gray-400 hover:text-gray-600"
                >
                  None
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-3 gap-x-6">
              @for (perm of getFilteredCategoryPermissions(category); track perm.id) {
              <label class="flex items-start gap-2.5 cursor-pointer group select-none">
                <input
                  type="checkbox"
                  class="mt-0.5 w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer transition-colors"
                  [checked]="isPermissionSelected(perm.name)"
                  (change)="togglePermission(perm.name, $any($event.target).checked)"
                />
                <div class="flex-1 min-w-0">
                  <p
                    class="text-sm text-gray-700 font-medium leading-tight group-hover:text-gray-900 transition-colors"
                  >
                    {{ getPermissionAction(perm.name) | titlecase }}
                  </p>
                  <p
                    class="text-[10px] text-gray-400 font-mono mt-0.5 truncate"
                    title="{{ perm.name }}"
                  >
                    {{ perm.name }}
                  </p>
                </div>
              </label>
              }
            </div>
          </div>
          }
        </div>
        }
      </div>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions class="!px-6 !py-4 !border-t !border-gray-200 !flex !justify-end !bg-gray-50">
  <button mat-button (click)="onCancel()" class="!text-gray-600 !mr-2">Cancel</button>
  <button
    mat-flat-button
    color="primary"
    (click)="onSave()"
    class="!rounded-lg !px-6"
    [disabled]="!roleForm.valid || store.isSaving() || selectedPermissions().length === 0"
  >
    @if (store.isSaving()) {
    <mat-spinner diameter="18" class="!mr-2 !text-white"></mat-spinner> Saving... } @else {
    {{ isEdit ? 'Save Changes' : 'Create Role' }}
    }
  </button>
</mat-dialog-actions>
