<aside
  [class]="
    'relative z-30 flex h-screen flex-col border border-divider/40 shadow-sm bg-white  transition-all duration-300 ease-in-out ' +
    (collapsed ? 'w-16' : 'w-64')
  "
>
  <div
    class="flex h-16 shrink-0 items-center justify-between border-b border-divider/60 px-3 bg-white"
  >
    <div
      [class]="
        'flex items-center gap-3 transition-all duration-300 ' + (collapsed ? 'justify-center' : '')
      "
    >
      <div
        class="flex h-8 w-8 items-center justify-center rounded-lg bg-primary text-white shadow-sm shadow-primary/30"
      >
        <mat-icon fontSet="material-symbols-rounded" class="!text-[20px]"
          >medical_services</mat-icon
        >
      </div>

      @if (!collapsed) {
      <div class="flex flex-col overflow-hidden">
        <span class="truncate text-sm font-bold text-slate-800">FlexCare</span>
        <span class="truncate text-[10px] font-medium uppercase tracking-wider text-slate-500"
          >Admin Console</span
        >
      </div>
      }
    </div>

    @if (!collapsed) {
    <button
      mat-icon-button
      (click)="toggle.emit()"
      class="!h-8 !w-8 !shrink-0 text-slate-400 hover:text-slate-700"
    >
      <mat-icon fontSet="material-symbols-rounded" class="!text-[18px]">menu_open</mat-icon>
    </button>
    }
  </div>

  <div class="flex-1 overflow-y-auto overflow-x-hidden p-3 scrollbar-hide">
    <nav class="space-y-1">
      @for (item of items(); track item.label) { @if (item.children && item.children.length > 0) {

      <div [class.justify-center]="collapsed" class="flex flex-col">
        <button
          (click)="toggleExpand(item.label)"
          [class]="
            'group flex w-full items-center gap-3 rounded-lg px-3 py-2 text-left text-sm font-medium transition-all duration-200 border-l-4 ' +
            (hasActiveChild(item)
              ? '!bg-gradient-to-r !from-primary/10 !to-primary/5 !text-primary !font-semibold !border-primary'
              : isExpanded(item.label)
              ? 'text-slate-900 bg-slate-100 border-transparent'
              : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900 border-transparent') +
            (collapsed ? ' justify-center' : '')
          "
          [matTooltip]="collapsed ? item.label : ''"
          matTooltipPosition="right"
        >
          <mat-icon
            fontSet="material-symbols-rounded"
            class="!text-[20px] shrink-0 transition-colors"
            [class.text-primary]="isExpanded(item.label) || hasActiveChild(item)"
          >
            {{ item.icon }}
          </mat-icon>

          @if (!collapsed) {
          <span class="flex-1 truncate">{{ item.label }}</span>
          <mat-icon
            fontSet="material-symbols-rounded"
            class="!text-[18px] text-slate-400 transition-transform duration-200"
            [class.rotate-180]="isExpanded(item.label)"
            [class.text-primary]="hasActiveChild(item)"
          >
            keyboard_arrow_down
          </mat-icon>
          }
        </button>
        <!-- <button
          (click)="toggleExpand(item.label)"
          [class]="
            'group flex w-full items-center gap-3 rounded-lg px-3 py-2 text-left text-sm font-medium transition-colors ' +
            (isExpanded(item.label)
              ? 'text-slate-900 bg-slate-100'
              : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900') +
            (collapsed ? ' justify-center' : '')
          "
          [matTooltip]="collapsed ? item.label : ''"
          matTooltipPosition="right"
        >
          <mat-icon
            fontSet="material-symbols-rounded"
            class="!text-[20px] shrink-0 transition-colors"
            [class.text-primary]="isExpanded(item.label)"
          >
            {{ item.icon }}
          </mat-icon>

          @if (!collapsed) {
          <span class="flex-1 truncate">{{ item.label }}</span>
          <mat-icon
            fontSet="material-symbols-rounded"
            class="!text-[18px] text-slate-400 transition-transform duration-200"
            [class.rotate-180]="isExpanded(item.label)"
          >
            keyboard_arrow_down
          </mat-icon>
          }
        </button> -->

        @if (!collapsed && isExpanded(item.label)) {
        <div
          class="relative mt-1 ml-[22px] pl-5 border-l-2 border-slate-200 space-y-1 animate-in slide-in-from-top-2 duration-200"
        >
          @for (child of item.children; track child.label) {

          <!-- Second level: Check if child has its own children (3rd level) -->
          @if (child.children && child.children.length > 0) {
          <div class="flex flex-col">
            <button
              (click)="toggleExpand(child.label)"
              [class]="
                'group flex w-full items-center gap-2 rounded-lg px-3 py-2 text-left text-sm font-medium transition-all duration-200 ' +
                (hasActiveChild(child)
                  ? '!text-primary !font-semibold !bg-primary/10'
                  : isExpanded(child.label)
                  ? 'text-slate-900 bg-slate-100'
                  : 'text-slate-600 hover:bg-primary-50 hover:text-slate-900')
              "
            >
              @if (child.icon) {
              <mat-icon
                fontSet="material-symbols-rounded"
                class="!text-[18px] shrink-0 transition-colors"
                [class.text-primary]="isExpanded(child.label) || hasActiveChild(child)"
              >
                {{ child.icon }}
              </mat-icon>
              }
              <span class="flex-1 truncate">{{ child.label }}</span>
              <mat-icon
                fontSet="material-symbols-rounded"
                class="!text-[16px] text-slate-400 transition-transform duration-200"
                [class.rotate-180]="isExpanded(child.label)"
                [class.text-primary]="hasActiveChild(child)"
              >
                keyboard_arrow_down
              </mat-icon>
            </button>

            <!-- Third level: Grandchildren -->
            @if (isExpanded(child.label)) {
            <div
              class="relative mt-1 ml-6 pl-3 border-l-2 border-slate-200 space-y-1 animate-in slide-in-from-top-2 duration-200"
            >
              @for (grandchild of child.children; track grandchild.href) {
              <a
                [routerLink]="grandchild.href"
                routerLinkActive="!text-primary !font-semibold !bg-primary/10 before:!opacity-100"
                class="relative block rounded-lg px-3 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-all before:absolute before:left-0 before:top-1/2 before:-translate-y-1/2 before:-translate-x-[13px] before:h-1.5 before:w-1.5 before:rounded-full before:bg-primary before:opacity-0 before:transition-opacity"
              >
                {{ grandchild.label }}
              </a>
              }
            </div>
            }
          </div>
          } @else if (child.href) {
          <!-- Second level: Direct link (no children) -->
          <a
            [routerLink]="child.href"
            routerLinkActive="!text-primary !font-semibold !bg-primary/10 before:!opacity-100"
            class="relative flex items-center gap-2 rounded-lg px-3 py-2.5 text-sm text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition-all before:absolute before:left-0 before:top-1/2 before:-translate-y-1/2 before:-translate-x-[21px] before:h-2 before:w-2 before:rounded-full before:bg-primary before:opacity-0 before:transition-opacity"
          >
            @if (child.icon) {
            <mat-icon fontSet="material-symbols-rounded" class="!text-[18px] shrink-0">
              {{ child.icon }}
            </mat-icon>
            }
            <span class="truncate">{{ child.label }}</span>
          </a>
          } }
        </div>
        }
      </div>

      } @else {

      <a
        [routerLink]="item.href"
        routerLinkActive="bg-slate-400 text-white shadow-md shadow-primary/20"
        [routerLinkActiveOptions]="{ exact: item.href === '/' }"
        [class]="
          'group flex items-center gap-3 rounded-lg px-3 py-2 transition-all duration-200 ' +
          (collapsed ? 'justify-center' : '')
        "
        [matTooltip]="collapsed ? item.label : ''"
        matTooltipPosition="right"
      >
        <mat-icon
          fontSet="material-symbols-rounded"
          class="!text-[20px] shrink-0"
          [class]="
            'text-slate-500 group-[.bg-primary]:text-white group-hover:text-slate-900 group-[.bg-primary]:group-hover:text-white'
          "
        >
          {{ item.icon }}
        </mat-icon>

        @if (!collapsed) {
        <span
          class="truncate text-sm font-medium text-slate-600 group-[.bg-primary]:text-white group-hover:text-slate-900 group-[.bg-primary]:group-hover:text-white"
        >
          {{ item.label }}
        </span>
        }
      </a>
      } }
    </nav>
  </div>

  <div class="border-t border-divider/60 p-2 bg-slate-50/50">
    <button
      mat-icon-button
      (click)="toggle.emit()"
      class="!w-full !text-slate-400 hover:!text-slate-700 hover:!bg-white"
    >
      <mat-icon fontSet="material-symbols-rounded" class="!text-[20px]">
        {{ collapsed ? 'last_page' : 'first_page' }}
      </mat-icon>
    </button>
  </div>
</aside>
