<!-- libs/medical/feature/src/lib/dialogs/medical-quick-quote-dialog/medical-quick-quote-dialog.html -->

<div class="flex flex-col max-h-[90vh] max-w-[70vw]">
  <!-- Header -->
  <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
    <div class="flex items-center gap-3">
      <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10">
        <mat-icon fontSet="material-symbols-rounded" class="!text-primary">calculate</mat-icon>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Quick Quote</h2>
        <p class="text-sm text-slate-500">Calculate premium without creating an application</p>
      </div>
    </div>
    <button mat-icon-button (click)="cancel()" class="!text-slate-400">
      <mat-icon fontSet="material-symbols-rounded">close</mat-icon>
    </button>
  </div>

  <!-- Content -->
  <div class="flex-1 overflow-y-auto p-6">
    @if (!quote()) {
    <!-- Quote Input Form -->
    <form [formGroup]="memberForm" class="space-y-6">
      <!-- Plan Selection -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">
          Select Plan <span class="text-red-500">*</span>
        </label>
        <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
          <mat-select formControlName="plan_id" required>
            @for (plan of plans(); track plan.id) {
            <mat-option [value]="plan.id">
              {{ plan.name }}
              <span class="text-xs text-slate-500">({{ plan.scheme?.name }})</span>
            </mat-option>
            }
          </mat-select>
          @if (memberForm.get('plan_id')?.hasError('required') &&
          memberForm.get('plan_id')?.touched) {
          <mat-error>Plan is required</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Members Section -->
      <div>
        <div class="mb-4 flex items-center justify-between">
          <label class="block text-sm font-medium text-slate-700">Members to Cover</label>
          <button
            mat-stroked-button
            type="button"
            (click)="addMember()"
            class="!border-primary !text-primary"
          >
            <mat-icon fontSet="material-symbols-rounded">add</mat-icon>
            Add Member
          </button>
        </div>

        <div formArrayName="members" class="space-y-3">
          @for (member of membersArray.controls; track $index; let i = $index) {
          <div [formGroupName]="i" class="rounded-lg border border-slate-200 p-4">
            <div class="mb-3 flex items-center justify-between">
              <span class="text-sm font-medium text-slate-700">Member {{ i + 1 }}</span>
              @if (membersArray.length > 1) {
              <button
                mat-icon-button
                type="button"
                (click)="removeMember(i)"
                class="!w-6 !h-6 !text-slate-400 hover:!text-red-600"
              >
                <mat-icon fontSet="material-symbols-rounded" class="!text-[16px]">close</mat-icon>
              </button>
              }
            </div>

            <div class="grid grid-cols-3 gap-3">
              <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <!-- <mat-label>Member Type</mat-label> -->
                <mat-select formControlName="member_type">
                  @for (type of memberTypes; track type.value) {
                  <mat-option [value]="type.value">{{ type.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <!-- <mat-label>Age</mat-label> -->
                <input matInput type="number" formControlName="age" min="0" max="100" />
                @if ($any(member).get('age')?.hasError('required') &&
                $any(member).get('age')?.touched) {
                <mat-error>Age is required</mat-error>
                } @else if ($any(member).get('age')?.hasError('min') ||
                $any(member).get('age')?.hasError('max')) {
                <mat-error>Age must be between 0 and 100</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <!-- <mat-label>Gender</mat-label> -->
                <mat-select formControlName="gender">
                  <mat-option value="M">Male</mat-option>
                  <mat-option value="F">Female</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
          }
        </div>
      </div>
    </form>
    } @else {
    <!-- Quote Results -->
    <div class="space-y-6">
      <!-- Plan Info -->
      <div class="rounded-lg border border-slate-200 p-4">
        <h3 class="mb-3 text-sm font-medium text-slate-900">{{ quote()!.plan.name }}</h3>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <span class="text-slate-500">Plan Code:</span>
            <span class="ml-2 font-medium text-slate-900">{{ quote()!.plan.code }}</span>
          </div>
          <div>
            <span class="text-slate-500">Rate Card:</span>
            <span class="ml-2 font-medium text-slate-900"
              >{{ quote()!.rate_card.code }} v{{ quote()!.rate_card.version }}</span
            >
          </div>
          <div>
            <span class="text-slate-500">Valid Until:</span>
            <span class="ml-2 font-medium text-slate-900">{{
              formatDate(quote()!.valid_until)
            }}</span>
          </div>
          <div>
            <span class="text-slate-500">Billing:</span>
            <span class="ml-2 font-medium text-slate-900">{{
              getBillingLabel(quote()!.frequency)
            }}</span>
          </div>
        </div>
      </div>

      <!-- Members Table -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-3">Covered Members</label>
        <div class="rounded-lg border border-slate-200 overflow-hidden">
          <table class="w-full">
            <thead class="border-b border-slate-200 bg-slate-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500">
                  Member Type
                </th>
                <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500">
                  Age
                </th>
                <th class="px-4 py-2 text-left text-xs font-semibold uppercase text-slate-500">
                  Gender
                </th>
                <th class="px-4 py-2 text-right text-xs font-semibold uppercase text-slate-500">
                  Premium
                </th>
              </tr>
            </thead>
            <tbody>
              @for (member of quote()!.members; track $index) {
              <tr class="border-b border-slate-100 last:border-b-0">
                <td class="px-4 py-3 text-sm text-slate-700">
                  {{ getMemberTypeLabel(member.member_type) }}
                </td>
                <td class="px-4 py-3 text-sm text-slate-700">{{ member.age }} years</td>
                <td class="px-4 py-3 text-sm text-slate-700">
                  {{ member.gender === 'M' ? 'Male' : 'Female' }}
                </td>
                <td class="px-4 py-3 text-right text-sm font-medium text-slate-900">
                  {{ formatCurrency(member.premium, quote()!.currency) }}
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <!-- Premium Breakdown -->
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
        <label class="block text-sm font-medium text-slate-700 mb-3">Premium Breakdown</label>
        <div class="space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-slate-500">Base Premium</span>
            <span class="font-medium text-slate-900">{{
              formatCurrency(quote()!.base_premium, quote()!.currency)
            }}</span>
          </div>

          @if (quote()!.addon_premium > 0) {
          <div class="flex justify-between text-sm">
            <span class="text-slate-500">Add-on Premium</span>
            <span class="font-medium text-slate-900">{{
              formatCurrency(quote()!.addon_premium, quote()!.currency)
            }}</span>
          </div>
          } @if (quote()!.total_discount > 0) {
          <div class="flex justify-between text-sm">
            <span class="text-green-600">Discounts</span>
            <span class="font-medium text-green-600"
              >-{{ formatCurrency(quote()!.total_discount, quote()!.currency) }}</span
            >
          </div>
          } @if (quote()!.total_loading > 0) {
          <div class="flex justify-between text-sm">
            <span class="text-amber-600">Loadings</span>
            <span class="font-medium text-amber-600">{{
              formatCurrency(quote()!.total_loading, quote()!.currency)
            }}</span>
          </div>
          }

          <mat-divider class="!my-3"></mat-divider>

          <div class="flex justify-between">
            <span class="font-medium text-slate-900">Total Premium</span>
            <span class="text-lg font-bold text-primary">{{
              formatCurrency(quote()!.final_premium, quote()!.currency)
            }}</span>
          </div>

          <div class="text-center text-xs text-slate-500">
            per {{ getBillingLabel(quote()!.frequency).toLowerCase() }}
          </div>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Footer -->
  <div class="flex items-center justify-between px-6 py-4 border-t border-slate-200 bg-slate-50">
    @if (!quote()) {
    <div class="text-sm text-slate-500">
      {{ membersArray.length }} member{{ membersArray.length === 1 ? '' : 's' }} added
    </div>
    <div class="flex items-center gap-2">
      <button mat-button type="button" (click)="cancel()" class="!text-slate-600">Cancel</button>
      <button
        mat-flat-button
        color="primary"
        (click)="calculateQuote()"
        [disabled]="memberForm.invalid || isCalculating()"
      >
        @if (isCalculating()) {
        <mat-icon fontSet="material-symbols-rounded" class="animate-spin"
          >progress_activity</mat-icon
        >
        Calculating... } @else {
        <mat-icon fontSet="material-symbols-rounded">calculate</mat-icon>
        Calculate Quote }
      </button>
    </div>
    } @else {
    <button mat-stroked-button (click)="quote.set(null)" class="!border-slate-200">
      <mat-icon fontSet="material-symbols-rounded">arrow_back</mat-icon>
      New Quote
    </button>
    <div class="flex items-center gap-2">
      <button mat-button (click)="cancel()" class="!text-slate-600">Close</button>
      <button
        mat-flat-button
        color="primary"
        (click)="convertToApplication()"
        [disabled]="isConverting()"
      >
        @if (isConverting()) {
        <mat-icon fontSet="material-symbols-rounded" class="animate-spin"
          >progress_activity</mat-icon
        >
        Converting... } @else {
        <mat-icon fontSet="material-symbols-rounded">description</mat-icon>
        Convert to Application }
      </button>
    </div>
    }
  </div>
</div>
