<!-- libs/medical/ui/src/lib/dialogs/plan-benefit-dialog/plan-benefit-dialog.component.html -->

<div class="flex max-h-[90vh] w-full flex-col overflow-hidden bg-white sm:w-[650px]">
  <!-- Header -->
  <div class="flex items-center justify-between border-b border-slate-100 px-6 py-4">
    <div class="flex items-center gap-3">
      <div
        class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-100 text-blue-600"
      >
        <mat-icon fontSet="material-symbols-rounded">tune</mat-icon>
      </div>
      <div>
        <h2 class="text-lg font-semibold tracking-tight text-slate-900">Configure Benefit</h2>
        <p class="text-xs text-slate-500">{{ pb.benefit?.name || 'Benefit' }}</p>
      </div>
    </div>

    <button
      mat-icon-button
      (click)="dialogRef.close()"
      class="!text-slate-400 hover:!text-slate-700"
    >
      <mat-icon fontSet="material-symbols-rounded">close</mat-icon>
    </button>
  </div>

  <!-- Stepper Content -->
  <div class="flex-1 overflow-y-auto">
    <mat-stepper
      #stepper
      [linear]="false"
      [selectedIndex]="currentStep()"
      (selectionChange)="onStepChange($event.selectedIndex)"
      class="!bg-transparent"
    >
      <!-- Step 1: Limits -->
      <mat-step [stepControl]="limitsForm" label="Limits">
        <form [formGroup]="limitsForm" class="p-6 space-y-5">
          <p class="text-sm text-slate-500 mb-4">
            Define the coverage limits for this benefit on this specific plan.
          </p>

          <!-- Limit Type -->
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-slate-700">Limit Type</label>
            <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
              <mat-select formControlName="limit_type">
                <mat-select-trigger>
                  @if (limitsForm.get('limit_type')?.value; as limitType) {
                  <span>{{ getLimitTypeLabel(limitType) }}</span>
                  }
                </mat-select-trigger>
                @for (type of limitTypes; track type.value) {
                <mat-option [value]="type.value">
                  <div class="flex flex-col">
                    <span>{{ type.label }}</span>
                    <span class="text-xs text-slate-400">{{ type.description }}</span>
                  </div>
                </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Limit Values (conditional) -->
          @if (showLimitAmount) {
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-slate-700">Limit Amount</label>
            <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
              <span matTextPrefix class="text-slate-400 mr-1">ZMW</span>
              <input
                matInput
                type="number"
                formControlName="limit_amount"
                min="0"
                placeholder="e.g. 50000"
              />
            </mat-form-field>
            <p class="text-xs text-slate-400">
              Maximum amount covered per
              {{ getLimitFrequencyLabel(limitsForm.get('limit_frequency')?.value) }}
            </p>
          </div>
          } @if (showLimitCount) {
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-slate-700">Limit Count</label>
            <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
              <input
                matInput
                type="number"
                formControlName="limit_count"
                min="0"
                placeholder="e.g. 12"
              />
              <span matTextSuffix class="text-slate-400">times</span>
            </mat-form-field>
            <p class="text-xs text-slate-400">Maximum number of uses/visits allowed</p>
          </div>
          } @if (showLimitDays) {
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-slate-700">Limit Days</label>
            <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
              <input
                matInput
                type="number"
                formControlName="limit_days"
                min="0"
                placeholder="e.g. 30"
              />
              <span matTextSuffix class="text-slate-400">days</span>
            </mat-form-field>
            <p class="text-xs text-slate-400">Maximum days of coverage</p>
          </div>
          }

          <!-- Frequency & Basis -->
          <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col gap-1.5">
              <label class="text-sm font-medium text-slate-700">Frequency</label>
              <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <mat-select formControlName="limit_frequency">
                  <mat-select-trigger>
                    @if (limitsForm.get('limit_frequency')?.value; as freq) {
                    <span>{{ getLimitFrequencyLabel(freq) }}</span>
                    }
                  </mat-select-trigger>
                  @for (freq of limitFrequencies; track freq.value) {
                  <mat-option [value]="freq.value">{{ freq.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <div class="flex flex-col gap-1.5">
              <label class="text-sm font-medium text-slate-700">Basis</label>
              <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <mat-select formControlName="limit_basis">
                  <mat-select-trigger>
                    @if (limitsForm.get('limit_basis')?.value; as basis) {
                    <span>{{ getLimitBasisLabel(basis) }}</span>
                    }
                  </mat-select-trigger>
                  @for (basis of limitBases; track basis.value) {
                  <mat-option [value]="basis.value">{{ basis.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- Additional Limits -->
          <div class="rounded-lg border border-slate-200 p-4">
            <h4 class="text-sm font-medium text-slate-700 mb-3">Additional Limits (Optional)</h4>
            <div class="grid grid-cols-3 gap-4">
              <div class="flex flex-col gap-1">
                <label class="text-xs text-slate-500">Per Claim Max</label>
                <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                  <input
                    matInput
                    type="number"
                    formControlName="per_claim_limit"
                    min="0"
                    placeholder="0"
                  />
                </mat-form-field>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-xs text-slate-500">Per Day Max</label>
                <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                  <input
                    matInput
                    type="number"
                    formControlName="per_day_limit"
                    min="0"
                    placeholder="0"
                  />
                </mat-form-field>
              </div>
              <div class="flex flex-col gap-1">
                <label class="text-xs text-slate-500">Max Claims/Year</label>
                <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                  <input
                    matInput
                    type="number"
                    formControlName="max_claims_per_year"
                    min="0"
                    placeholder="0"
                  />
                </mat-form-field>
              </div>
            </div>
          </div>
        </form>
      </mat-step>

      <!-- Step 2: Cost Sharing -->
      <mat-step [stepControl]="costSharingForm" label="Cost Sharing" [optional]="true">
        <form [formGroup]="costSharingForm" class="p-6 space-y-5">
          <p class="text-sm text-slate-500 mb-4">
            Define how costs are shared between the insurer and member for this specific benefit.
          </p>

          <!-- Copay Type -->
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-slate-700">Copay Type</label>
            <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
              <mat-select formControlName="copay_type">
                <mat-select-trigger>
                  @if (costSharingForm.get('copay_type')?.value === 'fixed') {
                  <span>Fixed Amount</span>
                  } @else {
                  <span>Percentage</span>
                  }
                </mat-select-trigger>
                <mat-option value="fixed">Fixed Amount</mat-option>
                <mat-option value="percentage">Percentage</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Copay Value -->
          <div class="grid grid-cols-2 gap-4">
            @if (costSharingForm.get('copay_type')?.value === 'fixed') {
            <div class="flex flex-col gap-1.5">
              <label class="text-sm font-medium text-slate-700">Copay Amount</label>
              <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <span matTextPrefix class="text-slate-400 mr-1">ZMW</span>
                <input
                  matInput
                  type="number"
                  formControlName="copay_amount"
                  min="0"
                  placeholder="e.g. 100"
                />
              </mat-form-field>
              <p class="text-xs text-slate-400">Fixed amount member pays per claim</p>
            </div>
            } @else {
            <div class="flex flex-col gap-1.5">
              <label class="text-sm font-medium text-slate-700">Copay Percentage</label>
              <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <input
                  matInput
                  type="number"
                  formControlName="copay_percentage"
                  min="0"
                  max="100"
                  placeholder="e.g. 20"
                />
                <span matTextSuffix class="text-slate-400">%</span>
              </mat-form-field>
              <p class="text-xs text-slate-400">Percentage of claim member pays</p>
            </div>
            }

            <div class="flex flex-col gap-1.5">
              <label class="text-sm font-medium text-slate-700">Deductible</label>
              <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <span matTextPrefix class="text-slate-400 mr-1">ZMW</span>
                <input
                  matInput
                  type="number"
                  formControlName="deductible"
                  min="0"
                  placeholder="0"
                />
              </mat-form-field>
              <p class="text-xs text-slate-400">Amount paid before coverage starts</p>
            </div>
          </div>

          <!-- Out of Pocket Max -->
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-slate-700">Out-of-Pocket Maximum</label>
            <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
              <span matTextPrefix class="text-slate-400 mr-1">ZMW</span>
              <input
                matInput
                type="number"
                formControlName="out_of_pocket_max"
                min="0"
                placeholder="0"
              />
            </mat-form-field>
            <p class="text-xs text-slate-400">
              Maximum member pays for this benefit per year (0 = no limit)
            </p>
          </div>

          <div class="rounded-lg bg-blue-50 border border-blue-100 p-4">
            <div class="flex gap-3">
              <mat-icon fontSet="material-symbols-rounded" class="!text-blue-500">info</mat-icon>
              <div>
                <p class="text-sm font-medium text-blue-900">Benefit-Level Override</p>
                <p class="text-xs text-blue-700 mt-1">
                  These cost sharing settings override the plan's default settings for this specific
                  benefit only.
                </p>
              </div>
            </div>
          </div>
        </form>
      </mat-step>

      <!-- Step 3: Settings -->
      <mat-step [stepControl]="settingsForm" label="Settings" [optional]="true">
        <form [formGroup]="settingsForm" class="p-6 space-y-5">
          <p class="text-sm text-slate-500 mb-4">Configure additional settings for this benefit.</p>

          <!-- Waiting Period -->
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-slate-700">Waiting Period</label>
            <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
              <input
                matInput
                type="number"
                formControlName="waiting_period_days"
                min="0"
                placeholder="0"
              />
              <span matTextSuffix class="text-slate-400">days</span>
            </mat-form-field>
            <p class="text-xs text-slate-400">
              Days from cover start before this benefit can be claimed
            </p>
          </div>

          <!-- Coverage Toggle -->
          <div
            class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50/50 p-4"
          >
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">Covered</span>
              <span class="text-xs text-slate-500">Enable coverage for this benefit</span>
            </div>
            <mat-slide-toggle formControlName="is_covered" color="primary"></mat-slide-toggle>
          </div>

          <!-- Visibility Toggle -->
          <div
            class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50/50 p-4"
          >
            <div class="flex flex-col">
              <span class="text-sm font-semibold text-slate-900">Visible to Members</span>
              <span class="text-xs text-slate-500">Show this benefit on member schedules</span>
            </div>
            <mat-slide-toggle formControlName="is_visible" color="primary"></mat-slide-toggle>
          </div>

          <!-- Notes -->
          <div class="flex flex-col gap-1.5">
            <label class="text-sm font-medium text-slate-700">Internal Notes</label>
            <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
              <textarea
                matInput
                formControlName="notes"
                rows="3"
                placeholder="Any special conditions or notes..."
                class="!resize-none"
              ></textarea>
            </mat-form-field>
            <p class="text-xs text-slate-400">For internal reference only, not shown to members</p>
          </div>
        </form>
      </mat-step>
    </mat-stepper>
  </div>

  <!-- Footer with Navigation -->
  <div class="flex items-center justify-between border-t border-slate-100 bg-slate-50 px-6 py-4">
    <div class="text-xs text-slate-500">Step {{ currentStep() + 1 }} of 3</div>

    <div class="flex items-center gap-3">
      <button mat-button (click)="dialogRef.close()" class="!text-slate-600 hover:!bg-slate-200">
        Cancel
      </button>

      <!-- Back Button -->
      @if (!isFirstStep) {
      <button mat-stroked-button (click)="prevStep()" class="!border-slate-300">
        <mat-icon fontSet="material-symbols-rounded">arrow_back</mat-icon>
        Back
      </button>
      }

      <!-- Next Button -->
      @if (!isLastStep) {
      <button
        mat-flat-button
        color="primary"
        [disabled]="!canGoNext"
        (click)="nextStep()"
        class="!px-6 !rounded-lg"
      >
        Next
        <mat-icon fontSet="material-symbols-rounded">arrow_forward</mat-icon>
      </button>
      } @else {
      <!-- Save Button (only on last step) -->
      <button
        mat-flat-button
        color="primary"
        [disabled]="!isFormValid"
        (click)="save()"
        class="!px-6 !rounded-lg"
      >
        Save Configuration
      </button>
      }
    </div>
  </div>
</div>
