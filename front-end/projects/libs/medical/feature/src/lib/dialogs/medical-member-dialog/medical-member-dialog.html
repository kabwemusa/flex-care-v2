<div class="flex flex-col h-full w-[700px] max-h-[90vh]">
  <!-- Header -->
  <div class="flex items-center justify-between px-6 py-4 border-b border-slate-100 bg-slate-50">
    <div class="flex items-center gap-3">
      <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-indigo-100">
        <mat-icon fontSet="material-symbols-rounded" class="!text-indigo-600">
          {{ isEdit ? 'person_edit' : 'person_add' }}
        </mat-icon>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-slate-900">
          {{ isEdit ? 'Edit Member' : 'Register New Member' }}
        </h2>
        <p class="text-xs text-slate-500">
          {{ isEdit ? 'Update member details' : 'Add a principal or dependent' }}
        </p>
      </div>
    </div>
    <button mat-icon-button (click)="dialogRef.close()" class="!text-slate-400">
      <mat-icon fontSet="material-symbols-rounded">close</mat-icon>
    </button>
  </div>

  <!-- Content -->
  <div class="flex-1 overflow-y-auto p-6">
    <form [formGroup]="form" class="space-y-6">
      <!-- Context Section -->
      <div class="space-y-4">
        <h3 class="text-sm font-medium text-slate-700 flex items-center gap-2">
          <mat-icon fontSet="material-symbols-rounded" class="!text-[18px] text-slate-400"
            >policy</mat-icon
          >
          Membership Context
        </h3>

        <div class="grid grid-cols-2 gap-4">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <mat-select formControlName="policy_id" placeholder="Select Policy">
              @for (policy of activePolicies(); track policy.id) {
              <mat-option [value]="policy.id">
                {{ policy.policy_number }} - {{ policy.holder_name }}
              </mat-option>
              }
            </mat-select>
            <mat-icon matSuffix fontSet="material-symbols-rounded" class="!text-slate-400"
              >policy</mat-icon
            >
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <mat-select formControlName="member_type" placeholder="Member Type">
              @for (type of MEMBER_TYPES; track type.value) {
              <mat-option [value]="type.value">{{ type.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        @if (!isPrincipal()) {
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
          <mat-select formControlName="relationship" placeholder="Relationship to Principal">
            @for (rel of RELATIONSHIPS; track rel.value) { @if (rel.value !== 'self') {
            <mat-option [value]="rel.value">{{ rel.label }}</mat-option>
            } }
          </mat-select>
        </mat-form-field>
        }
      </div>

      <mat-divider></mat-divider>

      <!-- Personal Details -->
      <div class="space-y-4">
        <h3 class="text-sm font-medium text-slate-700 flex items-center gap-2">
          <mat-icon fontSet="material-symbols-rounded" class="!text-[18px] text-slate-400"
            >person</mat-icon
          >
          Personal Details
        </h3>

        <div class="grid grid-cols-2 gap-4">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <input matInput formControlName="first_name" placeholder="First Name" />
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <input matInput formControlName="last_name" placeholder="Last Name" />
          </mat-form-field>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <mat-select formControlName="gender" placeholder="Gender">
              @for (g of GENDERS; track g.value) {
              <mat-option [value]="g.value">{{ g.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <input
              matInput
              [matDatepicker]="dobPicker"
              formControlName="date_of_birth"
              placeholder="Date of Birth"
            />
            <mat-datepicker-toggle matSuffix [for]="dobPicker"></mat-datepicker-toggle>
            <mat-datepicker #dobPicker></mat-datepicker>
          </mat-form-field>
        </div>

        @if (calculatedAge() !== null) {
        <p class="text-sm text-slate-500">Age: {{ calculatedAge() }} years</p>
        }

        <div class="grid grid-cols-2 gap-4">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <input matInput formControlName="national_id" placeholder="National ID / NRC" />
            <mat-icon matSuffix fontSet="material-symbols-rounded" class="!text-slate-400"
              >badge</mat-icon
            >
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <input matInput formControlName="passport_number" placeholder="Passport (Optional)" />
          </mat-form-field>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Contact Details -->
      <div class="space-y-4">
        <h3 class="text-sm font-medium text-slate-700 flex items-center gap-2">
          <mat-icon fontSet="material-symbols-rounded" class="!text-[18px] text-slate-400"
            >contact_phone</mat-icon
          >
          Contact Details
        </h3>

        <div class="grid grid-cols-2 gap-4">
          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <input matInput type="email" formControlName="email" placeholder="Email Address" />
            <mat-icon matSuffix fontSet="material-symbols-rounded" class="!text-slate-400"
              >mail</mat-icon
            >
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
            <input matInput formControlName="phone" placeholder="Phone Number" />
            <mat-icon matSuffix fontSet="material-symbols-rounded" class="!text-slate-400"
              >call</mat-icon
            >
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
          <textarea
            matInput
            formControlName="address"
            rows="2"
            placeholder="Physical Address"
          ></textarea>
        </mat-form-field>

        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
          <input matInput formControlName="city" placeholder="City / Town" />
        </mat-form-field>
      </div>
    </form>
  </div>

  <!-- Footer -->
  <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-slate-100 bg-slate-50">
    <button mat-button (click)="dialogRef.close()" class="!text-slate-600">Cancel</button>
    <button
      mat-flat-button
      color="primary"
      (click)="save()"
      [disabled]="isSaving() || form.invalid"
    >
      @if (isSaving()) {
      <mat-spinner diameter="20" class="mr-2"></mat-spinner>
      }
      <mat-icon fontSet="material-symbols-rounded">{{ isEdit ? 'save' : 'person_add' }}</mat-icon>
      {{ isEdit ? 'Update' : 'Create' }} Member
    </button>
  </div>
</div>
