<div class="rounded-xl border border-slate-200 bg-white shadow-sm p-6">
  <!-- Header -->
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-base font-semibold text-slate-900">Documents</h2>
      <p class="text-sm text-slate-500">Upload and manage application documents</p>
    </div>
  </div>

  <!-- Upload Form -->
  @if (canEdit()) {
  <form [formGroup]="uploadForm" (ngSubmit)="uploadDocument()" class="mb-6">
    <div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
      <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
        <!-- Document Type -->
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
          <mat-label>Document Type</mat-label>
          <mat-select formControlName="document_type">
            @for (type of documentTypes; track type.value) {
            <mat-option [value]="type.value">{{ type.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Title -->
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
          <mat-label>Title/Description</mat-label>
          <input matInput formControlName="title" placeholder="Enter document title" />
        </mat-form-field>

        <!-- Member (Optional) -->
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full">
          <mat-label>Related to Member (Optional)</mat-label>
          <mat-select formControlName="application_member_id">
            <mat-option value="">Application Level</mat-option>
            @for (member of members(); track member.id) {
            <mat-option [value]="member.id">
              {{ member.first_name }} {{ member.last_name }}
            </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <!-- File Upload -->
      <div class="mt-4">
        <div class="flex items-center gap-3">
          <input
            type="file"
            #fileInput
            (change)="onFileSelected($event)"
            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
            class="hidden"
          />

          @if (!selectedFile()) {
          <button
            type="button"
            mat-stroked-button
            (click)="fileInput.click()"
            class="!border-primary !text-primary"
          >
            <mat-icon fontSet="material-symbols-rounded">upload_file</mat-icon>
            Choose File
          </button>
          <span class="text-xs text-slate-500"> PDF, JPG, PNG, DOC, DOCX (Max 10MB) </span>
          } @else {
          <div
            class="flex flex-1 items-center justify-between rounded-lg border border-slate-200 bg-white px-4 py-2"
          >
            <div class="flex items-center gap-2">
              <mat-icon fontSet="material-symbols-rounded" class="!text-blue-600"
                >description</mat-icon
              >
              <div>
                <p class="text-sm font-medium text-slate-900">{{ selectedFile()!.name }}</p>
                <p class="text-xs text-slate-500">
                  {{ formatFileSize(selectedFile()!.size) }}
                </p>
              </div>
            </div>
            <button
              type="button"
              mat-icon-button
              (click)="removeSelectedFile()"
              class="!text-slate-400 hover:!text-red-600"
            >
              <mat-icon fontSet="material-symbols-rounded">close</mat-icon>
            </button>
          </div>
          } @if (selectedFile()) {
          <button
            type="submit"
            mat-flat-button
            color="primary"
            [disabled]="uploadForm.invalid || isUploading()"
          >
            @if (isUploading()) {
            <mat-spinner diameter="20" class="!mr-2"></mat-spinner>
            } @else {
            <mat-icon fontSet="material-symbols-rounded">cloud_upload</mat-icon>
            } Upload
          </button>
          }
        </div>
      </div>
    </div>
  </form>
  }

  <!-- Documents Table -->
  @if (isLoading()) {
  <div class="flex items-center justify-center py-12">
    <mat-spinner diameter="32"></mat-spinner>
  </div>
  } @else if (hasDocuments()) {
  <div class="overflow-x-auto">
    <table mat-table [dataSource]="documents()" class="w-full">
      <!-- Document Type -->
      <ng-container matColumnDef="document_type">
        <th mat-header-cell *matHeaderCellDef class="!font-semibold !text-slate-700">Type</th>
        <td mat-cell *matCellDef="let doc">
          <span class="rounded-full bg-blue-100 px-2 py-1 text-xs font-medium text-blue-700">
            {{ getDocumentTypeLabel(doc.document_type) }}
          </span>
        </td>
      </ng-container>

      <!-- Title -->
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef class="!font-semibold !text-slate-700">Title</th>
        <td mat-cell *matCellDef="let doc">
          <span class="font-medium text-slate-900">{{ doc.title }}</span>
        </td>
      </ng-container>

      <!-- File Name -->
      <ng-container matColumnDef="file_name">
        <th mat-header-cell *matHeaderCellDef class="!font-semibold !text-slate-700">File</th>
        <td mat-cell *matCellDef="let doc">
          <div class="flex items-center gap-2">
            <mat-icon fontSet="material-symbols-rounded" class="!text-[18px] !text-slate-400"
              >description</mat-icon
            >
            <span class="text-sm text-slate-600">{{ doc.file_name }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Member -->
      <ng-container matColumnDef="member">
        <th mat-header-cell *matHeaderCellDef class="!font-semibold !text-slate-700">Related To</th>
        <td mat-cell *matCellDef="let doc">
          <span class="text-sm text-slate-600">{{ getMemberName(doc) }}</span>
        </td>
      </ng-container>

      <!-- Created At -->
      <ng-container matColumnDef="created_at">
        <th mat-header-cell *matHeaderCellDef class="!font-semibold !text-slate-700">Uploaded</th>
        <td mat-cell *matCellDef="let doc">
          <span class="text-sm text-slate-600">{{ formatDate(doc.created_at) }}</span>
        </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="!font-semibold !text-slate-700"></th>
        <td mat-cell *matCellDef="let doc">
          <div class="flex items-center gap-1">
            <button
              mat-icon-button
              matTooltip="Download"
              class="!text-slate-400 hover:!text-primary"
            >
              <mat-icon fontSet="material-symbols-rounded">download</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns" class="hover:bg-slate-50"></tr>
    </table>
  </div>
  } @else {
  <div class="rounded-lg border-2 border-dashed border-slate-200 py-12 text-center">
    <mat-icon fontSet="material-symbols-rounded" class="">folder_open</mat-icon>
    <p class="mt-2 text-sm text-slate-500">No documents uploaded yet</p>
    @if (canEdit()) {
    <p class="text-xs text-slate-400">Upload supporting documents for this application</p>
    }
  </div>
  }
</div>
